# feathers-arangodb
[![Greenkeeper badge](https://badges.greenkeeper.io/feathersjs-ecosystem/feathers-mongodb.svg)](https://greenkeeper.io/)

[![Build Status](https://travis-ci.org/Brian-McBride/feathers-arangodb.png?branch=master)](https://travis-ci.org/Brian-McBride/feathers-arangodb)
[![Dependency Status](https://img.shields.io/david/Brian-McBride/feathers-arangodb.svg?style=flat-square)](https://david-dm.org/Brian-McBride/feathers-arangodb)
[![Download Status](https://img.shields.io/npm/dm/feathers-arangodb.svg?style=flat-square)](https://www.npmjs.com/package/feathers-arangodb)

A [Feathers](https://feathersjs.com) database adapter for [ArangoDB](https://www.arango.org/) using [official NodeJS driver for ArangoDB](https://github.com/arangodb/arangojs).

```bash
$ npm install --save arangojs feathers-arangodb
```

> __Important:__ `feathers-arangodb` implements the [Feathers Common database adapter API](https://docs.feathersjs.com/api/databases/common.html) and [querying syntax](https://docs.feathersjs.com/api/databases/querying.html).

> This adapter also requires a [running ArangoDB](https://docs.arangodb.com/3.3/Manual/GettingStarted/) database server.


## Initalization File

Now create a file to use in feathersJS initialization (i.e. arangodb.js).

```javascript
const Database = require('arangojs').Database;

module.exports = function () {
  const app = this;
  const config = app.get('arangodb');
  const promise = dbConnect(config);

  app.set('arangoClient', promise);
};

function dbConnect (options = {}) {
  const host = options.host || process.env.ARANGODB_HOST;
  const port = options.port || process.env.ARANGODB_PORT;
  const databaseName = options.database || process.env.ARANGODB_DB;

  const basicAuth = options.basicAuth || {};
  const username = basicAuth.username || process.env.ARANGODB_USERNAME;
  const password = basicAuth.password || process.env.ARANGODB_PASSWORD;

  const url = `${host}:${port}`;

  const db = new Database(url);
  db.useDatabase(databaseName);
  if (username) db.useBasicAuth(username, password);

  return new Promise((resolve, reject) => {
    db.get()
      .then(() => resolve(db))
      .catch(err => reject(err));
  });
}
```

## Setup in app.js
Either modify the app.js file generated by the FeathersJS CLI or add this to your own startup sequence:
You will need to add these lines into app.js in the appropriate spots:
```javascript
const arangodb = require('./arangodb'); // Or whatever path/filename you created above
app.configure(arangodb);
```

## Create a service
You can create your service. Note that you do need to init the database which will verify and create the specified collection.
```javascript
const createService = require('../../connectors/feathers-arangodb');
const hooks = require('./someservice.hooks');

module.exports = function (app) {
  const paginate = app.get('paginate');
  const arangoClient = app.get('arangoClient');

  const options = {
    paginate
  };

  // Initialize our service with any options it requires
  app.use('/someservice', createService(options));

  // Get our initialized service so that we can register hooks and filters
  const service = app.service('/someservice');

  arangoClient.then(db => {
    service.init(db, 'someservice');
  });

  service.hooks(hooks);
};
```

## Custom AQL Queries
There is a lot that ArangoDB can do beyond the simple CRUD that feathers exposes.
The method `query` on the service is a straight pass-through to the ArangoJS Query. 
It returns a cursor object as expected.
https://docs.arangodb.com/devel/Drivers/JS/Reference/Database/Queries.html#aql
####To Use:
An in creating custom hooks in the file `someservice.hooks`.
Read more about creating hooks in the feathers docs: https://docs.feathersjs.com/api/hooks.html
```javascript
module.exports = {
                   before: {
                     get: [
                       async function(context) {
                       
                         // Create a query
                         let queryString = aql`
                                   FOR user IN people
                                   FILTER user.name == "Nancy"
                                   RETURN user
                                 `;
                         
                         // Get the cursor
                         let cursor = await context.service.query(queryString);
                         
                         // Do something with it - in this case, get all the data in an array
                         let data = await cursor.all();
                         
                         // Update the result (the message)
                         context.result.user = data;
                         
                         // Returning will resolve the promise with the `context` object
                         return context;
                       }
                     ]
                   }
                 }
```

Copyright (c) 2018

Licensed under the [MIT license](LICENSE).
